<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiMyBNeUNhciIsImxvbmdfbmFtZSI6IkRvdmUgaG8gcGFyY2hlZ2dpYXRvPyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMDA3YWZmIn0=">

    <title>MyCar</title>

    <style>
        :root {
            /* Variabili Light Mode */
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --accent: #007AFF;
            --success: #34C759;
            --danger: #FF3B30;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --radius: 20px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #000000;
                --card-bg: #1c1c1e;
                --text-primary: #ffffff;
                --text-secondary: #98989f;
                --shadow: 0 4px 20px rgba(0,0,0,0.4);
            }
        }

        /* Reset */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            /* FIX CRUCIALE PER ANDROID: */
            min-height: 100vh;
            min-height: 100dvh; /* Altezza dinamica reale */
            display: flex;
            flex-direction: column;
            /* Permetti lo scroll se lo schermo √® piccolo */
            overflow-y: auto; 
        }

        .app-shell {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            /* Padding extra in basso per evitare che la barra home copra i tasti */
            padding-bottom: max(30px, env(safe-area-inset-bottom));
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header */
        header {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 800;
            margin: 0;
        }

        p.subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            margin-top: 4px;
        }

        /* Area centrale flessibile */
        .content-area {
            flex: 1; /* Prende tutto lo spazio disponibile */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        /* Card Stato */
        .status-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            width: 100%;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .big-icon {
            font-size: 60px;
            margin-bottom: 15px;
            display: block;
        }

        .status-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .time-badge {
            display: inline-block;
            background: rgba(128, 128, 128, 0.15);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Pulsanti fissati in basso */
        .actions {
            margin-top: auto; /* Spinge i bottoni in fondo */
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 20px;
        }

        button {
            width: 100%;
            height: 54px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.97); }

        .btn-primary { background-color: var(--accent); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-ghost { background-color: transparent; color: var(--danger); border: 1px solid rgba(255, 59, 48, 0.2); }

        .hidden { display: none !important; }
        
        /* Animazione pulsante */
        .pulsing { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <h1>MyCar</h1>
            <p class="subtitle">Utility di parcheggio</p>
        </header>

        <div class="content-area">
            <div id="view-empty" class="status-card">
                <div class="big-icon">üìç</div>
                <div class="status-text">Dove hai parcheggiato?</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top:5px;">
                    Attiva il GPS e premi il tasto blu
                </div>
            </div>

            <div id="view-saved" class="status-card hidden">
                <div class="big-icon">üöó</div>
                <div class="status-text">Posizione Salvata</div>
                <div class="time-badge" id="time-display">--:--</div>
            </div>
        </div>

        <div class="actions">
            <button id="btn-save" class="btn-primary" onclick="handleSave()">
                Memorizza Posizione
            </button>

            <button id="btn-nav" class="btn-success hidden" onclick="handleNavigate()">
                üó∫Ô∏è Portami all'auto
            </button>

            <button id="btn-delete" class="btn-ghost hidden" onclick="handleDelete()">
                Cancella
            </button>
        </div>
    </div>

    <script>
        const els = {
            viewEmpty: document.getElementById('view-empty'),
            viewSaved: document.getElementById('view-saved'),
            btnSave: document.getElementById('btn-save'),
            btnNav: document.getElementById('btn-nav'),
            btnDelete: document.getElementById('btn-delete'),
            timeDisplay: document.getElementById('time-display')
        };

        // Avvio
        window.onload = () => {
            if (localStorage.getItem('car_lat')) showSaved();
            else showEmpty();
        };

        function vibrate() {
            if (navigator.vibrate) navigator.vibrate(20);
        }

        function handleSave() {
            vibrate();
            if (!navigator.geolocation) return alert("GPS non disponibile");

            const originalText = els.btnSave.textContent;
            els.btnSave.textContent = "Ricerca GPS...";
            els.btnSave.style.opacity = "0.7";
            els.viewEmpty.classList.add('pulsing');

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const now = new Date();
                    const timeStr = now.toLocaleDateString('it-IT', { day:'numeric', month:'short' }) + ", " + 
                                    now.toLocaleTimeString('it-IT', { hour:'2-digit', minute:'2-digit' });

                    localStorage.setItem('car_lat', pos.coords.latitude);
                    localStorage.setItem('car_lng', pos.coords.longitude);
                    localStorage.setItem('car_time', timeStr);
                    
                    showSaved();
                    if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
                },
                (err) => {
                    alert("Errore: Attiva il GPS!");
                    els.btnSave.textContent = originalText;
                    els.viewEmpty.classList.remove('pulsing');
                    els.btnSave.style.opacity = "1";
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        function handleNavigate() {
            vibrate();
            const lat = localStorage.getItem('car_lat');
            const lng = localStorage.getItem('car_lng');
            if(lat && lng) {
                window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;
            }
        }

        function handleDelete() {
            vibrate();
            if(confirm("Cancellare la posizione?")) {
                localStorage.removeItem('car_lat');
                localStorage.removeItem('car_lng');
                localStorage.removeItem('car_time');
                showEmpty();
            }
        }

        function showSaved() {
            els.viewEmpty.classList.add('hidden');
            els.viewEmpty.classList.remove('pulsing');
            els.viewSaved.classList.remove('hidden');
            
            els.timeDisplay.textContent = localStorage.getItem('car_time');
            
            els.btnSave.classList.add('hidden');
            els.btnNav.classList.remove('hidden');
            els.btnDelete.classList.remove('hidden');
            
            // Reset bottone salva
            els.btnSave.textContent = "Memorizza Posizione";
            els.btnSave.style.opacity = "1";
        }

        function showEmpty() {
            els.viewSaved.classList.add('hidden');
            els.viewEmpty.classList.remove('hidden');
            
            els.btnNav.classList.add('hidden');
            els.btnDelete.classList.add('hidden');
            els.btnSave.classList.remove('hidden');
        }
    </script>
</body>
</html>
